<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>乌入入</title>
<style>
  body {
    font-family: "Microsoft YaHei", sans-serif;
    background: #eaeaea;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .canvas-container {
    position: relative;
    width: 90vw;
    max-width: 800px;
    aspect-ratio: 1 / 1;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-top: 10px;
  }
  .layer {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
  }
  .controls {
    display: flex;
    justify-content: center;
    overflow-x: auto;
    width: 100%;
    background: #fff;
    margin-top: 10px;
    border-top: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
  }
  .controls button {
    flex: 1;
    font-size: 16px;
    border: none;
    background: transparent;
    padding: 10px;
    border-right: 1px solid #ccc;
  }
  .controls button:last-child {
    border-right: none;
  }
  .controls button.active {
    font-weight: bold;
    background: #f9f9f9;
  }
  .options {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .options img {
    width: 70px;
    height: 70px;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    background: #fff;
  }
  .options img.selected {
    border-color: #ffb800;
  }
  .save-btn {
    margin: 12px 0;
    padding: 10px 20px;
    background: #ffd66b;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }
  footer {
    font-size: 14px;
    color: #555;
    margin-bottom: 20px;
  }
</style>
</head>
<body>

  <div class="canvas-container" id="canvas">
    <img id="layer-hair-back" class="layer">
    <img id="layer-face" class="layer">
    <img id="layer-hair-front" class="layer">
    <img id="layer-sideburn" class="layer">
    <img id="layer-eyebrow" class="layer">
    <img id="layer-eye" class="layer">
    <img id="layer-mouth" class="layer">
    <img id="layer-decoration" class="layer">
    <img id="layer-watermark" class="layer">
  </div>

  <div class="controls" id="category-buttons"></div>
  <div class="options" id="option-list"></div>

  <button class="save-btn" id="save-btn">保存图片</button>

  <footer>此捏人是用于在闲鱼：乌入入 定制人类头套而制作的，<br>
因为属于半定制，价格比全定制低很多，配件少是正常的…！<br>
右边的神秘数字就是参考价（最低价）。<br>
<br>
不需要定制头套的人也可以用来捏[已有的]角色或OC/发帖配图/做头像。<br>
其余之外的[任何事]都不可以…！<br>
<br>
捏人作者:乌入入,仿生鱼鱼。<br></footer>

  <script>
    const categories = [
      { key: "hair-back", name: "后发", folder: "后发" },
      { key: "face", name: "脸", folder: "脸" },
      { key: "hair-front", name: "前发", folder: "前发" },
      { key: "sideburn", name: "鬓角", folder: "鬓角" },
      { key: "eyebrow", name: "眉毛", folder: "眉毛" },
      { key: "eye", name: "眼睛", folder: "眼睛" },
      { key: "mouth", name: "嘴巴", folder: "嘴巴" },
      { key: "decoration", name: "装饰", folder: "装饰" },
      { key: "watermark", name: "水印", folder: "水印" }
    ];

    const categoryButtons = document.getElementById("category-buttons");
    const optionList = document.getElementById("option-list");
    let currentCategory = categories[0].key;
    const selections = {};

    // 生成按钮
    categories.forEach(cat => {
      const btn = document.createElement("button");
      btn.textContent = cat.name;
      if (cat.key === currentCategory) btn.classList.add("active");
      btn.onclick = () => {
        document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentCategory = cat.key;
        renderOptions(cat);
      };
      categoryButtons.appendChild(btn);
    });

    // 加载素材（自动检测有多少）
    async function loadCategoryImages(folder) {
      const images = [];
      for (let i = 1; i <= 30; i++) { // 最多尝试30张
        const url = `assets/${folder}${i}.png`;
        try {
          const res = await fetch(url);
          if (res.ok) images.push(url);
          else break;
        } catch {
          break;
        }
      }
      return images;
    }

    // 渲染选项
    async function renderOptions(cat) {
      optionList.innerHTML = "";
      const imgs = await loadCategoryImages(cat.folder);
      optionList.innerHTML = "";
      imgs.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        if (selections[cat.key] === src) img.classList.add("selected");
        img.onclick = () => {
          selections[cat.key] = src;
          document.getElementById("layer-" + cat.key).src = src;
          renderOptions(cat);
        };
        optionList.appendChild(img);
      });
    }

    // 初始化默认第一张
    async function init() {
      for (const cat of categories) {
        const imgs = await loadCategoryImages(cat.folder);
        if (imgs.length > 0) {
          selections[cat.key] = imgs[0];
          document.getElementById("layer-" + cat.key).src = imgs[0];
        }
      }
      renderOptions(categories[0]);
    }

    init();

    // 保存图片功能
    document.getElementById("save-btn").onclick = async () => {
      const canvasContainer = document.getElementById("canvas");
      const canvas = document.createElement("canvas");
      const size = canvasContainer.clientWidth;
      canvas.width = 800;
      canvas.height = 800;
      const ctx = canvas.getContext("2d");
      for (const cat of categories) {
        const imgEl = document.getElementById("layer-" + cat.key);
        if (imgEl.src) {
          const img = await createImageBitmap(imgEl);
          ctx.drawImage(img, 0, 0, 800, 800);
        }
      }
      const link = document.createElement("a");
      link.download = "nieren.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    };
  </script>
</body>
</html>
